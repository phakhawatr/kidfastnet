
# แผนแก้ไขปัญหาการสร้างภารกิจรายวันไม่ทันที

## ปัญหาที่พบจากการวิเคราะห์

### 1. Bug สำคัญ: `supabaseAdmin` ไม่ถูกกำหนดค่า
ในไฟล์ `generate-daily-mission/index.ts` บรรทัด 414 มีการอ้างอิงตัวแปร `supabaseAdmin` ซึ่งไม่มีการประกาศไว้ (มีแค่ `supabase`) ทำให้เมื่อ AI หมดเวลา (timeout 30 วินาที) ระบบ fallback จะ crash ทันที --> นักเรียนไม่ได้ภารกิจเลย

### 2. การสร้างภารกิจช้า (รอ AI 10-30 วินาที)
ทุกครั้งที่สร้างภารกิจต้องเรียก Groq AI ซึ่งใช้เวลา 5-30 วินาที ทำให้นักเรียนต้องรอนาน หากวันนี้ (14 ก.พ.) ยังไม่มีภารกิจ ต้องรอ AI สร้างใหม่ทุกครั้ง

### 3. Regeneration ลบภารกิจก่อนสร้างใหม่
เมื่อมีภารกิจไม่ครบ 3 ตัว ระบบจะ **ลบภารกิจเดิมทั้งหมด** ก่อนเรียก AI สร้างใหม่ หาก AI ล้มเหลว นักเรียนจะไม่มีภารกิจเลย

### 4. ข้อมูลยืนยัน
- มีภารกิจทั้งหมด 239 รายการ, สำเร็จเพียง 36 รายการ (15%)
- ผู้ใช้หลักมีภารกิจ pending สะสมหลายสิบรายการที่ไม่เคยทำ
- วันนี้ (14 ก.พ.) ยังไม่มีภารกิจถูกสร้าง

---

## แผนแก้ไข

### ขั้นตอนที่ 1: แก้ Bug `supabaseAdmin` (Critical)
แก้ไข `supabase/functions/generate-daily-mission/index.ts` บรรทัด 414 เปลี่ยน `supabaseAdmin` เป็น `supabase` เพื่อให้ fallback ทำงานได้จริง

### ขั้นตอนที่ 2: เพิ่มระบบ "Instant Fallback" (สร้างภารกิจทันทีโดยไม่ต้องรอ AI)
เพิ่มลอจิกใน Edge Function:
- ถ้า AI ยังไม่ตอบภายใน 8 วินาที ให้ใช้ "Smart Fallback" แทน
- Smart Fallback จะเลือกทักษะจากประวัติของนักเรียนโดยตรง (ไม่ต้องเรียก AI)
- ใช้ลอจิกง่ายๆ: ทักษะที่อ่อนสุด = ง่าย, ทักษะกลาง = กลาง, ทักษะใหม่ = ยาก
- ผลลัพธ์: นักเรียนได้ภารกิจภายใน 2-3 วินาที แทนที่จะรอ 30 วินาที

### ขั้นตอนที่ 3: แก้ไข Regeneration Logic
- เปลี่ยนจาก "ลบก่อน แล้วสร้างใหม่" เป็น "สร้างใหม่ก่อน แล้วค่อยลบเก่า"
- ป้องกันกรณีที่ AI ล้มเหลวแล้วไม่มีภารกิจเหลือ

### ขั้นตอนที่ 4: เพิ่ม Pre-generation ตอน Login
- เมื่อนักเรียน login สำเร็จ ให้เรียก generate-daily-mission ทันทีในพื้นหลัง (background)
- ทำให้เมื่อเปิดหน้าปฏิทิน ภารกิจพร้อมใช้งานอยู่แล้ว

### ขั้นตอนที่ 5: ปรับ Frontend ให้แสดง Loading ที่ดีขึ้น
- แสดง skeleton loading cards แทนหน้าว่าง
- เพิ่มปุ่ม "สร้างภารกิจให้ฉัน" ที่เห็นชัดเจนเมื่อไม่มีภารกิจ
- ลด timeout จาก 35 วินาที เป็น 15 วินาที (เพราะมี instant fallback แล้ว)

---

## รายละเอียดทางเทคนิค

### ไฟล์ที่ต้องแก้ไข

| ไฟล์ | การเปลี่ยนแปลง |
|------|----------------|
| `supabase/functions/generate-daily-mission/index.ts` | แก้ bug supabaseAdmin, เพิ่ม Smart Fallback 8 วินาที, ปรับ timeout logic |
| `src/hooks/useTrainingCalendar.ts` | แก้ regeneration logic (สร้างก่อนลบ), ลด timeout, เพิ่ม pre-generation |
| `src/pages/TodayFocusMode.tsx` | เพิ่ม skeleton loading, ปรับ UI retry button |

### Smart Fallback Logic (ไม่ใช้ AI)

```text
Input: ประวัติ 7 วัน + skill_assessments
                |
    +-----------+-----------+
    |           |           |
 ภารกิจ 1    ภารกิจ 2    ภารกิจ 3
 ทักษะอ่อน   ทักษะกลาง   ทักษะใหม่
 (easy)      (medium)    (hard)
    |           |           |
 เลือกจาก    เลือกจาก    สุ่มจาก
 weakSkills  recentSkills availableSkills
```

### ลำดับการทำงานใหม่

```text
นักเรียนเปิดหน้าภารกิจ
         |
    มีภารกิจ 3 ตัว?
    /          \
  Yes           No
   |             |
 แสดงทันที    เรียก Edge Function
               |
          AI ตอบใน 8 วินาที?
          /              \
        Yes               No
         |                 |
    ใช้ผล AI         Smart Fallback
         |                 |
         +--------+--------+
                  |
           บันทึก DB + แสดงผล
           (รวม 2-10 วินาที)
```

### ผลลัพธ์ที่คาดหวัง
- กรณีปกติ (AI ตอบเร็ว): ได้ภารกิจใน 3-8 วินาที
- กรณี AI ช้า/ล้มเหลว: ได้ภารกิจใน 2-3 วินาที (Smart Fallback)
- ไม่มีกรณีที่นักเรียนไม่ได้ภารกิจเลย
